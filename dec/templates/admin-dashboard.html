{% extends "base.html" %}

{% block content %}
{% load static %}
<style type="text/css">
	.custom-table td {
	    padding: 10px 10px !important;
	}
</style>
<div class="content container-fluid">

	<div class="page-header">
		<div class="row">
			<div class="col-sm-8">
				<h3 class="page-title">Welcome {{ request.session.first_name }},</h3>
				<ul class="breadcrumb">
					<li class="breadcrumb-item active">Dashboard</li>
				</ul>
			</div>

			<div class="col-sm-4">
				<form action="#" class="row" id="month_data">
					<div class="row">
						<div class="col-sm-6">
							<div class="input-block mb-3 form-focus">
								<select class="select floating" id="monthList" name="month">
								    <option value="">Select</option>
								    <option value="1" {% if current_month == 1 %}selected{% endif %}>January</option>
								    <option value="2" {% if current_month == 2 %}selected{% endif %}>February</option>
								    <option value="3" {% if current_month == 3 %}selected{% endif %}>March</option>
								    <option value="4" {% if current_month == 4 %}selected{% endif %}>April</option>
								    <option value="5" {% if current_month == 5 %}selected{% endif %}>May</option>
								    <option value="6" {% if current_month == 6 %}selected{% endif %}>June</option>
								    <option value="7" {% if current_month == 7 %}selected{% endif %}>July</option>
								    <option value="8" {% if current_month == 8 %}selected{% endif %}>August</option>
								    <option value="9" {% if current_month == 9 %}selected{% endif %}>September</option>
								    <option value="10" {% if current_month == 10 %}selected{% endif %}>October</option>
								    <option value="11" {% if current_month == 11 %}selected{% endif %}>November</option>
								    <option value="12" {% if current_month == 12 %}selected{% endif %}>December</option>
								</select>
			                    <label class="focus-label">Date</label>
							</div>
						</div>
						<div class="col-sm-3">
							<div class="input-block mb-3 form-focus">
								<select class="select floating" id="yearList" name="year">
									<option value="2024" {% if current_year == 2024 %}selected{% endif %}>2024</option>
									<option value="2025" {% if current_year == 2025 %}selected{% endif %}>2025</option>
									<option value="2026" {% if current_year == 2026 %}selected{% endif %}>2026</option>
								</select>
								<label class="focus-label">Year</label>
							</div>
						</div>
	                    <div class="col-sm-3">
	                    	<button class="btn btn-primary" type="button" id="update_month" style="font-weight: 600;font-size: 18px;padding: 8px 20px;">Search</button>
	                    </div>
					</div>
                </form>
			</div>
		</div>
	</div>

	<div class="row">
		<div class="col-md-6 col-sm-6 col-lg-6 col-xl-3">
			<div class="card dash-widget">
				<a href="{% url 'current_clients' %}" style="color: var(--bs-body-color);">
				<div class="card-body">
					<span class="dash-widget-icon"><i class="fa-solid fa-users"></i></span>
					<div class="dash-widget-info">
						<h3>{{ client_count }}</h3>
						<span>Total Clients</span>
					</div>
				</div>
				</a>
			</div>
		</div>
		<div class="col-md-6 col-sm-6 col-lg-6 col-xl-3">
			<div class="card dash-widget">
				<a href="{% url 'profile' logged_in_employee_id %}" style="color: var(--bs-body-color);">
				<div class="card-body">
					<span class="dash-widget-icon"><i class="fa-solid fa-users"></i></span>
					<div class="dash-widget-info">
						<h3>{{ logged_in_employee_client_count }}</h3>
						<span>My Clients</span>
					</div>
				</div>
				</a>
			</div>
		</div>
		
		<div class="col-md-6 col-sm-6 col-lg-6 col-xl-3">
			<div class="card dash-widget">
				<a href="{% url 'projects' %}" style="color: var(--bs-body-color);">
				<div class="card-body">
					<span class="dash-widget-icon"><i class="fa-solid fa-file"></i></span>
					<div class="dash-widget-info">
						<h3>{{ project_count }}</h3>
						<span>Total Projects</span>
					</div>
				</div>
				</a>
			</div>
		</div>

		<div class="col-md-6 col-sm-6 col-lg-6 col-xl-3">
			<div class="card dash-widget">
				<a href="{% url 'calender' %}" style="color: var(--bs-body-color);">
				<div class="card-body">
					<span class="dash-widget-icon"><i class="fa-solid fa-clock"></i></span>
					<div class="dash-widget-info">
						<!-- <h3>{{ project_count }}</h3> -->
						<!-- <h3>{{ total_hours_month }}</h3>
						<span>Total Hours This Month</span> -->
						<h3>{{ total_working_hours }}</h3>
						<span>Contracted Hrs/Week</span>
					</div>
				</div>
				</a>
			</div>
		</div>
	</div>
	<style type="text/css">
		.dash-widget .card-body .dash-widget-info h3{
			font-size: 23px !important;
		}
		.dash-widget .card-body .dash-widget-info span{
			font-size: 14px !important;
		}
	</style>
	

	<div class="row">
	
		<div class="col-md-6 d-flex">
			<div class="card card-table flex-fill">
				<div class="card-header">
					<h3 class="card-title mb-0">Projects</h3>
				</div>
				<div class="card-body">
					<div class="table-responsive">
						<table class="table custom-table mb-0">
							<thead>
								<tr>
									<th>Name</th>
									<th>Leader</th>
									<th>Status</th>
								</tr>
							</thead>
							<tbody>
								{% for project_data in project_data_with_employees %}
								<tr>
									<td>
										<h2 class="table-avatar">
											<a href="{% url 'projects' %}" class="avatar">
												{% if project_data.project.uploaded_file %}
			                                        <!-- <img src="{{ project_data.project.uploaded_file }}" alt="User Image"> -->
			                                        <img src="{% static 'assets/img/client/project-sample.png' %}" alt="Default Image">
			                                    {% else %}
			                                        <img src="{% static 'assets/img/client/project-sample.png' %}" alt="Default Image">
			                                    {% endif %}
											</a>
											<a href="{% url 'projects' %}">{{ project_data.project.project_name }}</a>
										</h2>
									</td>
									<td>
										{% for employee in project_data.employee_details_by_role.L %}
										    {{ employee.name }}{% if not forloop.last %}, {% endif %}
										{% endfor %}
									</td>
									<td>
										<div class="dropdown action-label">
											{% if project_data.project.status == 'in_progress' %}
												<a class="btn btn-white btn-sm btn-rounded dropdown-toggle" href="javascript:void(0)" data-bs-toggle="dropdown" aria-expanded="false">
													<i class="fa-regular fa-circle-dot text-success"></i> 
													InProgress
												</a>
											{% elif project_data.project.status == 'completed' %}
										    	<a class="btn btn-white btn-sm btn-rounded dropdown-toggle" href="javascript:void(0)" data-bs-toggle="dropdown" aria-expanded="false">
													<i class="fa-regular fa-circle-dot text-danger"></i> 
													Completed
												</a>
											{% elif project_data.project.status == 'onboarding' %}
												<a class="btn btn-white btn-sm btn-rounded dropdown-toggle" href="javascript:void(0)" data-bs-toggle="dropdown" aria-expanded="false">
													<i class="fa-regular fa-circle-dot text-warning"></i> 
													Onboarding
												</a>
											{% else %}
										        <a class="btn btn-white btn-sm btn-rounded dropdown-toggle" href="javascript:void(0)" data-bs-toggle="dropdown" aria-expanded="false">
													<i class="fa-regular fa-circle-dot text-success"></i> 
													InProgress
												</a>
										    {% endif %}
											<div class="dropdown-menu dropdown-menu-right" data-id="{{project_data.project.id}}">
												<a class="dropdown-item confirmChk" href="javascript:void(0)" data-status="in_progress"><i class="fa-regular fa-circle-dot text-success"></i> InProgress</a>
												<a class="dropdown-item confirmChk" href="javascript:void(0)" data-status="onboarding"><i class="fa-regular fa-circle-dot text-warning"></i> Onboarding</a>
												<a class="dropdown-item confirmChk" href="javascript:void(0)" data-status="completed"><i class="fa-regular fa-circle-dot text-danger"></i> Completed</a>
											</div>
										</div>
									</td>
								</tr>
								{% endfor %}								
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
		<div class="col-md-12 col-lg-6 col-xl-6 d-flex">
			<div class="card card-table flex-fill">
				<div class="card-header">
					<h3 class="card-title mb-0">Clients</h3>
				</div>
				<div class="card-body">
					<div class="table-responsive">
						<table class="table custom-table mb-0">
							<thead>
								<tr>
									<th>Name</th>
									<th>Company</th>
								</tr>
							</thead>
							<tbody>
						        {% for entry in logged_in_employee_clients|slice:":5" %}
								<tr>
									<td>
										<h2 class="table-avatar">
											<a href="{% url 'client-profile' entry.client.id %}" class="avatar">
												{% if entry.client.image_url %}
			                                        <img src="{{ entry.client.image_url }}" alt="User Image">
			                                    {% else %}
			                                        <img src="{% static 'assets/img/user.jpg' %}" alt="Default Image">
			                                    {% endif %}
											</a>
											<a href="{% url 'client-profile' entry.client.id %}">{{ entry.client.client_name }}</a>
										</h2>
									</td>
									<td>{{ entry.client.company_name }}</td>
								</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="row">
	
		<div class="col-md-12 col-lg-6 col-xl-6 d-flex">
			<div class="card flex-fill">
				<div class="card-body">
					<h4 class="card-title">My Upcoming Leave</h4>
					{% for leave_detail in leaves_with_employees|slice:":3" %}
						<div class="leave-info-box">
							<div class="media d-flex align-items-center">
								<a href="{% url 'leave_employee' %}" class="avatar">
									{% if leave_detail.image_url %}
                                        <img src="{{ leave_detail.image_url }}" alt="User Image"></a>
                                    {% else %}
                                        <img src="{% static 'assets/img/user.jpg' %}" alt="Default Image">
                                    {% endif %}
								</a>
								<div class="media-body flex-grow-1">
									<div class="text-sm my-0">{{leave_detail.employee_name}}</div>
								</div>
							</div>
							<div class="row align-items-center mt-3">
								<div class="col-6">
									<h6 class="mb-0">
										{% if leave_detail.start_date == leave_detail.end_date %}
											{{leave_detail.start_date}}
										{% else %}
											{{leave_detail.start_date}} to {{leave_detail.end_date}}
										{% endif %}
									</h6>
								</div>
								<div class="col-6 text-end">
									<span class="badge {% if leave_detail.status == 'approved' %}bg-inverse-success{% else %}bg-inverse-danger{% endif %}">
									{{leave_detail.status|capfirst}}</span>
								</div>
							</div>
						</div>

					{% endfor %}
				</div>
			</div>
		</div>
		<div class="col-md-12 col-lg-6 col-xl-6 d-flex">
			<div class="card flex-fill">
				<div class="card-body">
					<h4 class="card-title">Leave <span class="badge bg-inverse-danger ms-2">{{ month_leaves_with_employees|length }}</span></h4>
					{% for leave_detail in month_leaves_with_employees|slice:":3" %}
						<div class="leave-info-box">
							<div class="media d-flex align-items-center">
								<a href="{% url 'leave_employee' %}" class="avatar">
									{% if leave_detail.image_url %}
                                        <img src="{{ leave_detail.image_url }}" alt="User Image"></a>
                                    {% else %}
                                        <img src="{% static 'assets/img/user.jpg' %}" alt="Default Image">
                                    {% endif %}
								</a>
								<div class="media-body flex-grow-1">
									<div class="text-sm my-0">{{leave_detail.employee_name}}</div>
								</div>
							</div>
							<div class="row align-items-center mt-3">
								<div class="col-6">
									<h6 class="mb-0">
										{% if leave_detail.start_date == leave_detail.end_date %}
											{{leave_detail.start_date}}
										{% else %}
											{{leave_detail.start_date}} to {{leave_detail.end_date}}
										{% endif %}
									</h6>
								</div>
								<div class="col-6 text-end">
									<span class="badge {% if leave_detail.status == 'approved' %}bg-inverse-success{% else %}bg-inverse-danger{% endif %}">
									{{leave_detail.status|capfirst}}</span>
								</div>
							</div>
						</div>
					{% endfor %}
				</div>
			</div>
		</div>
	</div>
	

</div>

<div class="modal custom-modal fade" id="change_project_status" role="dialog">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <div class="form-header">
                    <h3>Change Status</h3>
                    <p>Are you sure want to change status?</p>
                </div>
                <div class="modal-btn delete-action">
                    <div class="row">
                        <div class="col-6">
                            <input type="hidden" name="project_id" id="project_id" value="">
                            <input type="hidden" name="project_status" id="project_status" value="">
                            <a href="javascript:void(0);" class="btn btn-primary continue-btn" id="confirmBtn">Confirm</a>
                        </div>
                        <div class="col-6">
                            <a href="javascript:void(0);" data-bs-dismiss="modal" class="btn btn-primary cancel-btn">Decline</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script>
    $(document).ready(function(){
        $('#update_month').click(function() {
            var year = $("#yearList").val();
            var month = $("#monthList").val();
            if(month !=''){
                $.ajax({
                    // type: "POST",
                    url: '{% url "update_month" %}',
                    data: {'month': month, 'year': year},
                    success: function(response) {
                        window.location.reload();
                    },
                    error: function(xhr, errmsg, err) {
                        console.log('Error: ' + errmsg);
                    }
                });
            }else{
                alert("Please select category");
            }
        });
    });

    $(document).ready(function(){
        $(".confirmChk").click(function(){
            $("#project_id").val($(this).parent().attr('data-id'));
        	$("#project_status").val($(this).attr('data-status'));
        	$("#change_project_status").modal('show');
        });

        // Confirm button action
        $("#confirmBtn").click(function(){
            var project_id = $("#project_id").val();
            var project_status = $("#project_status").val();
            // alert('project_id '+project_id +' project_status '+project_status);
            // return false;
            if(project_id !='' && project_status !=''){
                $.ajax({
                    // type: "POST",
                    url: '{% url "update_project_status" %}',
                    data: {project_id:project_id,project_status:project_status},
                    success: function(response) {
                        if (response.status==1) {
                            if(project_status == 'onboarding'){
                                $('div[data-id="'+ project_id +'"]').parent('div').find('a:first').html('<i class="fa-regular fa-circle-dot text-warning"></i> Onboarding');
                            }else if(project_status == 'completed'){
                                $('div[data-id="'+ project_id +'"]').parent('div').find('a:first').html('<i class="fa-regular fa-circle-dot text-danger"></i> Completed');
                            }else{
                                $('div[data-id="'+ project_id +'"]').parent('div').find('a:first').html('<i class="fa-regular fa-circle-dot text-success"></i> InProgress');
                            }
                            // $('div[data-id="'+ project_id +'"]').parent('div').find('a').css('text-transform','capitalize');
                            $("#change_project_status").modal('hide');
                        }else{
                            $("#change_project_status").modal('hide');
                            alert('error');
                        }
                    },
                    error: function(xhr, errmsg, err) {
                        console.log('Error: ' + errmsg);
                    }
                });
            }
        });
    });
</script>
{% endblock %}
