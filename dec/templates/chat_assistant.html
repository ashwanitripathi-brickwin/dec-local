<!-- AI Assistant Chat Interface -->
<div id="AIAssistant" class="tab-pane fade show">
    <div class="main-wrapper">
        <div class="chat-wrapper">
            <div class="chat chat-messages show" id="middle">
                <div style="display: flex; flex-direction: column; height: 100%;">
                    <!-- Header -->
                    <!-- <div class="chat-header">
                        <div class="user-details">
                            <div class="ms-2">
                                <h6>AI Assistant</h6>
                            </div>
                        </div>
                    </div> -->

                    <!-- Chat Body -->
                    <div class="chat-body chat-page-group slimscroll">
                        <div class="messages" id="chat-messages">
                            <!-- Messages will be appended here -->
                        </div>
                    </div>

                    <!-- Chat Footer -->
                    <div class="chat-footer">
                        <form class="footer-form" id="ai-chat-form">
                            <div class="d-flex gap-2">
                                <input type="text" id="ai-message-input" class="form-control" placeholder="Type your message..." autocomplete="off" required />
                                <button class="btn btn-primary" type="submit">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CSS for AI Assistant -->
<style>
    /* CSS for AIAssistant Chat Interface */
    #AIAssistant {
        /* Adjust height as needed, or ensure its parent provides a constrained height */
        height: 70vh; /* Example: 70% of viewport height */
        min-height: 400px; /* Minimum height */
        display: flex;
        flex-direction: column;
    }

    #middle.chat.chat-messages {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        /* overflow: hidden; Important to contain children and manage layout */
        border: 1px solid #6c6e70; /* Optional: border for the chat box */
        border-radius: .25rem; /* Optional: rounded corners */
    }

    /* This is the direct div child of #middle that groups header, body, and footer */
    #middle > div {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        height: 100%; /* Occupy full height of #middle */
    }


    .chat-body.chat-page-group.slimscroll {
        flex-grow: 1; /* Allows chat body to take up available space */
        overflow-y: auto; /* Enables vertical scrolling */
        padding: 1rem;
        background-color: #fff; /* Background for message area */
    }
    /* Message styling */
    .messages .chats {
        display: flex;
        margin-bottom: 1rem;
    }

    .messages .chats .chat-avatar {
        flex-shrink: 0;
    }

    .messages .chats .chat-avatar img {
        width: 40px;
        height: 40px;
    }

    .messages .chats .chat-content {
        max-width: 75%; /* Limit width of message bubbles */
        display: flex;
        flex-direction: column;
    }
    
    .messages .chats .chat-content .message-content {
        padding: .5rem .75rem;
        border-radius: .75rem; /* Slightly more rounded bubbles */
        word-wrap: break-word; /* Ensure long words break */
        background-color: #fafbfc; /* Default message bubble color */
        color:#212529;
        position: relative; /* For emoji/actions positioning if needed */
    }

    .messages .chats .chat-avatar {
        margin-right: .75rem;
    }

    .messages .chats.chats-right {
        justify-content: flex-end; /* Align entire message block to the right */
    }

    .messages .chats.chats-right .chat-avatar {
        order: 1; /* Move avatar to the right */
        margin-right: 0;
        margin-left: .75rem;
    }

    .messages .chats.chats-right .chat-content {
        align-items: flex-end; /* Align items inside content (like profile name) to the right */
    }

    .messages .chats.chats-right .chat-content .message-content {
        background-color: #464747; /* User's message bubble color */
        color: white;
    }

    .chat-profile-name {
        font-size: 0.75em; /* Smaller text for name/time */
        color: #6c757d;
        margin-top: 0.25rem;
    }

    /* Footer input styling */
    .chat-footer .footer-form .chat-footer-wrap {
        display: flex;
        align-items: center;
    }

    .chat-footer .form-wrap {
        flex-grow: 1;
        margin: 0 0.5rem;
    }

    .chat-footer .form-wrap .form-control {
        border-radius: 20px; /* Rounded input field */
    }

    .chat-footer .form-item .action-circle,
    .chat-footer .form-btn .btn {
        width: 38px; /* Consistent button size */
        height: 38px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }
    
    .chat-footer .form-item .action-circle i,
    .chat-footer .form-btn .btn i {
        font-size: 1.1rem; /* Adjust icon size if needed */
    }

    .message {
        display: flex;
        margin-bottom: 10px;
        max-width: 100%;
    }

    .message.ai {
        justify-content: flex-start;
    }

    .message.user {
        justify-content: flex-end;
    }

    .message-content {
        padding: 10px 15px;
        border-radius: 15px;
        background-color: #464747;
        max-width: 100%;
    }

    .message.user .message-content {
        background-color: #464747;
        color: white;
        border-top-left-radius: 0;
    }

    .message.ai .message-content {
        background-color: #464747;
        color: white;
        border-top-right-radius: 0;
    }

    /* Override the slimscroll default settings */
    .slimScrollDiv {
        overflow: auto !important;
        height: auto !important; /* Allow parent to adjust to content */
        /* Remove duplicate scrollbar */
        overflow-y: hidden !important;
    }

    .chat-body.chat-page-group.slimscroll {
        overflow-y: auto !important; /* Only vertical scrollbar */
        overflow-x: hidden !important; /* Hide horizontal scrollbar */
        max-height: 60vh;
        height: auto !important;
        /* Remove any position properties that might cause layering issues */
        position: relative;
        
        /* Make scrollbar transparent/invisible */
        scrollbar-width: thin; /* For Firefox */
        scrollbar-color: transparent transparent; /* For Firefox */
    }

    /* WebKit browsers (Chrome, Safari, Edge) scrollbar styling */
    .chat-body.chat-page-group.slimscroll::-webkit-scrollbar {
        width: 6px; /* Thin scrollbar */
    }

    .chat-body.chat-page-group.slimscroll::-webkit-scrollbar-track {
        background: transparent; /* Transparent track */
    }

    .chat-body.chat-page-group.slimscroll::-webkit-scrollbar-thumb {
        background-color: rgba(0, 0, 0, 0.1); /* Very subtle thumb */
        border-radius: 10px;
    }

    /* Hide scrollbar completely but keep functionality */
    .chat-body.chat-page-group.slimscroll::-webkit-scrollbar {
        display: none; /* Hide scrollbar for Chrome, Safari and Opera */
    }

    /* Hide scrollbar elements that might be causing duplicate scrolls */
    .slimScrollBar, .slimScrollRail {
        display: none !important;
    }

    /* Ensure messages container doesn't overflow */
    #chat-messages {
        padding-bottom: 20px;
    }

    /* Fix for chat input not covering messages */
    .chat-footer {
        position: sticky;
        bottom: 0;
        background: white;
        z-index: 10;
        padding: 5px 49px 0px 0px;
        border-top: 0px solid #dee2e6;
    }

    /* Add this to your existing styles or at the end of your style section */
    .typing-indicator {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 5px 0;
    }

    .typing-indicator span {
        height: 8px;
        width: 8px;
        background: #fff; /* Match text color */
        display: block;
        border-radius: 50%;
        opacity: 0.7;
        animation: typing 1.2s infinite;
    }

    .typing-indicator span:nth-child(1) { animation-delay: 0s; }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
    }
    /* Make sure the chat container has a fixed position in the viewport */
    #AIAssistant .main-wrapper {
        position: relative;
        height: 70vh;
        display: flex;
        flex-direction: column;
    }

    #AIAssistant .chat-wrapper {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
    }

    /* Ensure the tab content area has appropriate dimensions */
    .tab-content {
        min-height: 70vh;
        padding-top: 0%;
    }

    #middle.chat.chat-messages {
        display: flex;
        flex-direction: column;
        flex: 1;
        /* overflow: hidden; */
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        height: 100%;
    }

    .chat-body.chat-page-group.slimscroll {
        flex: 1;
        overflow-y: auto !important; /* Force scroll behavior */
        padding: 1rem;
        background-color: #fff;
        height: calc(100% - 110px); /* Adjust based on header and footer heights */
        position: relative;
        min-height: 0; /* Critical for proper scrolling */
    }

    /* Fix for message display */
    #chat-messages {
        display: flex;
        flex-direction: column;
        width: 100%;
    }

    /* Improve the messages container to ensure content doesn't get hidden */
    .messages {
        display: flex;
        flex-direction: column;
        width: 100%;
        padding-bottom: 15px; /* Add padding at bottom to prevent messages being cut off */
    }
</style>

<style>
    /* Styling for the clickable and hoverable elements */
    .clickable {
        cursor: pointer;

    }
    .container {
        margin-top: -60px; /* Adjust this value as needed */
    }

    .custom-table td {
        padding: 10px 10px !important;
    }
    #drive_url::placeholder {
        color: #ccc; /* Light gray, adjust as needed */
        opacity: 1;  /* Full opacity for consistent look across browsers */
    }

    /* CSS for AIAssistant Chat Interface */
    #AIAssistant {
        /* Adjust height as needed, or ensure its parent provides a constrained height */
        height: 70vh; /* Example: 70% of viewport height */
        min-height: 400px; /* Minimum height */
        display: flex;
        flex-direction: column;
    }

    #middle.chat.chat-messages {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        /* overflow: hidden; Important to contain children and manage layout */
        border: 0px solid #6c6e70; /* Optional: border for the chat box */
        border-radius: .25rem; /* Optional: rounded corners */
    }

    /* This is the direct div child of #middle that groups header, body, and footer */
    #middle > div {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        height: 100%; /* Occupy full height of #middle */
    }

    .chat-header {
        flex-shrink: 0; /* Prevent header from shrinking */
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #dee2e6;
        background-color: #f8f9fa; /* Light background for header */
    }

    .chat-body.chat-page-group.slimscroll {
        flex-grow: 1; /* Allows chat body to take up available space */
        overflow-y: auto; /* Enables vertical scrolling */
        padding: 1rem;
        background-color: #fff; /* Background for message area */
    }



    /* Message styling */
    .messages .chats {
        display: flex;
        margin-bottom: 1rem;
    }

    .messages .chats .chat-avatar {
        flex-shrink: 0;
    }

    .messages .chats .chat-avatar img {
        width: 40px;
        height: 40px;
    }

    .messages .chats .chat-content {
        max-width: 75%; /* Limit width of message bubbles */
        display: flex;
        flex-direction: column;
    }
    
    .messages .chats .chat-content .message-content {
        padding: .5rem .75rem;
        border-radius: .75rem; /* Slightly more rounded bubbles */
        word-wrap: break-word; /* Ensure long words break */
        background-color: #464747; /* Default message bubble color */
        color:#212529;
        position: relative; /* For emoji/actions positioning if needed */
    }

    .messages .chats .chat-avatar {
        margin-right: .75rem;
    }

    .messages .chats.chats-right {
        justify-content: flex-end; /* Align entire message block to the right */
    }

    .messages .chats.chats-right .chat-avatar {
        order: 1; /* Move avatar to the right */
        margin-right: 0;
        margin-left: .75rem;
    }

    .messages .chats.chats-right .chat-content {
        align-items: flex-end; /* Align items inside content (like profile name) to the right */
    }

    .messages .chats.chats-right .chat-content .message-content {
        background-color: #464747; /* User's message bubble color */
        color: white;
    }

    .chat-profile-name {
        font-size: 0.75em; /* Smaller text for name/time */
        color: #6c757d;
        margin-top: 0.25rem;
    }

    /* Footer input styling */
    .chat-footer .footer-form .chat-footer-wrap {
        display: flex;
        align-items: center;
    }

    .chat-footer .form-wrap {
        flex-grow: 1;
        margin: 0 0.5rem;
    }

    .chat-footer .form-wrap .form-control {
        border-radius: 20px; /* Rounded input field */
    }

    .chat-footer .form-item .action-circle,
    .chat-footer .form-btn .btn {
        width: 38px; /* Consistent button size */
        height: 38px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }
    .chat-footer .form-item .action-circle i,
    .chat-footer .form-btn .btn i {
        font-size: 1.1rem; /* Adjust icon size if needed */
    }

</style>

<style>
.message {
    display: flex;
    margin-bottom: 10px;
    max-width: 100%;
}

/* .message.user {
    justify-content: flex-end;
} */

.message.ai {
    justify-content: flex-start;
}

.message-content {
    padding: 10px 15px;
    border-radius: 15px;
    background-color: #464747;
    max-width: 100%;
}

.message.user .message-content {
    background-color: #464747;
    border-top-left-radius: 0;
}

.message.ai .message-content {
    background-color: #212529;
    color: white;
    border-top-right-radius: 0;
}

</style>

<!-- JavaScript for AI Assistant -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the chat interface
    initChatInterface();
});

function initChatInterface() {
    // Add a welcome message when the tab is first shown
    $('a[href="#AIAssistant"]').on('shown.bs.tab', function (e) {
        const chatMessages = document.getElementById("chat-messages");
        if (chatMessages && chatMessages.childElementCount === 0) {
            appendMessage("ai", "Hi there! I'm your AI assistant. How can I help you today?");
        }
    });

    // Attach event listener to the form submission
    const chatForm = document.getElementById("ai-chat-form");
    if (chatForm) {
        chatForm.addEventListener("submit", handleChatSubmit);
    }

    // Fix the chat body scrolling issue
    const chatBodyElements = document.querySelectorAll('.chat-body.chat-page-group.slimscroll');
    
    chatBodyElements.forEach(function(element) {
        // Change overflow from hidden to auto
        element.style.overflow = 'auto';
        
        // Also update the parent slimScrollDiv if it exists
        const parentSlimScrollDiv = element.closest('.slimScrollDiv');
        if (parentSlimScrollDiv) {
            parentSlimScrollDiv.style.overflow = 'auto';
        }
    });
}

function handleChatSubmit(e) {
    e.preventDefault();

    const input = document.getElementById("ai-message-input");
    const message = input.value.trim();

    if (message === "") return;

    // Append user message
    appendMessage("user", message);

    // Clear input
    input.value = "";

    // Add loading indicator
    const loadingId = showLoadingIndicator();

    // Get the userId and clientId from the parent page
    const userId = document.getElementById("current-user-id") ? 
                  document.getElementById("current-user-id").value : 
                  "{{ request.user.id }}";
    
    const clientId = document.getElementById("current-client-id") ? 
                    document.getElementById("current-client-id").value : 
                    "{{ client.id }}";

    // Make webhook request to your n8n endpoint or other service
    fetch('https://n8n.educatedapp.com/webhook/0946a16b-a7dc-49c6-9b4a-69f62e2565c7', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            chatInput: message,
            sessionId: "web-user-123",
            userId: userId,
            clientId: clientId,
            timestamp: new Date().toISOString()
        })
    })
    .then(res => {
        if (!res.ok) throw new Error("Network response failed: " + res.status);
        return res.json();
    })
    .then(data => {
        // Remove loading indicator
        hideLoadingIndicator(loadingId);
        
        // Handle different response formats
        let reply;
        if (data && Array.isArray(data) && data.length > 0 && data[0].output) {
            // Format: [{output: "message"}]
            reply = data[0].output;
        } else if (data && data.response) {
            // Format: {response: "message"}
            reply = data.response;
        } else if (data && data.message) {
            // Format: {message: "message"}
            reply = data.message;
        } else if (data && data.output) {
            // Format: {output: "message"}
            reply = data.output;
        } else if (typeof data === 'string') {
            // Format: "message"
            reply = data;
        } else if (data) {
            // If it's an object but doesn't match known formats, try to extract any string property
            const propertyValue = Object.values(data).find(value => typeof value === 'string');
            if (propertyValue) {
                reply = propertyValue;
            } else {
                reply = "Response: " + JSON.stringify(data);
            }
        } else {
            reply = "⚠️ AI response format not recognized";
        }
        
        // Display the AI reply
        appendMessage("ai", reply);
    })
    .catch(err => {
        console.error("Error:", err);
        
        // Remove the loading indicator
        hideLoadingIndicator(loadingId);
        
        // Show error message
        appendMessage("ai", "❌ Failed to get a response. Please try again.");
    });
}

function showLoadingIndicator() {
    const chatMessages = document.getElementById("chat-messages");
    const loadingDiv = document.createElement("div");
    const id = "loading-" + Date.now();
    loadingDiv.id = id;
    loadingDiv.className = "message ai";
    loadingDiv.innerHTML = `
        <div class="message-content" style="display: flex; align-items: center;">
            <div class="typing-indicator">
                <span></span><span></span><span></span>
            </div>
        </div>
    `;
    chatMessages.appendChild(loadingDiv);
    scrollToBottom();
    return id;
}

function hideLoadingIndicator(id) {
    const element = document.getElementById(id);
    if (element) element.remove();
}

function appendMessage(sender, text) {
    const chatMessages = document.getElementById("chat-messages");
    
    const messageDiv = document.createElement("div");
    messageDiv.classList.add("message", sender);
    
    // Create the message content
    const messageContent = document.createElement("div");
    messageContent.className = "message-content";
    
    // Process text content differently based on sender
    if (sender === "ai" && (text.includes('\n') || text.includes('<pre>') || text.includes('<code>'))) {
        // Handle markdown-like formatting
        messageContent.innerHTML = formatMarkdown(text);
    } else if (sender === "ai") {
        // Clean up AI responses to remove markdown formatting
        messageContent.innerHTML = formatResponse(text);
    } else {
        // Simple text for user messages
        const paragraph = document.createElement("p");
        paragraph.style.margin = "0";
        paragraph.textContent = text;
        messageContent.appendChild(paragraph);
    }
    
    messageDiv.appendChild(messageContent);
    chatMessages.appendChild(messageDiv);
    
    // Scroll to the bottom to show the latest message
    scrollToBottom();
}

function scrollToBottom() {
    const chatBody = document.querySelector(".chat-body");
    if (chatBody) {
        // Use setTimeout to ensure this happens after the DOM has updated
        setTimeout(() => {
            chatBody.scrollTop = chatBody.scrollHeight;
        }, 10);
    }
}

function formatResponse(text) {
    // Remove markdown formatting symbols
    let cleanedText = text
        .replace(/\*\*/g, '') // Remove ** bold markers
        .replace(/##/g, '') // Remove ## header markers
        .replace(/###/g, '') // Remove ### subheader markers
        .replace(/\n\n/g, '<br><br>') // Convert line breaks to HTML breaks
        .replace(/\n/g, '<br>'); // Convert remaining line breaks
    
    return cleanedText;
}

function formatMarkdown(text) {
    // Convert code blocks
    let formattedText = text.replace(/```([\s\S]*?)```/g, '<pre style="background: #2d2d2d; color: #ccc; padding: 10px; border-radius: 5px; overflow-x: auto;">$1</pre>');
    
    // Convert inline code
    formattedText = formattedText.replace(/`([^`]+)`/g, '<code style="background: #2d2d2d; color: #ccc; padding: 2px 4px; border-radius: 3px;">$1</code>');
    
    // Convert new lines to <br>
    formattedText = formattedText.replace(/\n/g, '<br>');
    
    return formattedText;
}
</script>